<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadGen Pro - AI-Powered Lead Generation</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: white;
            overflow-x: hidden;
        }

        .app {
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(0, 212, 255, 0.1);
            border-left-color: #00d4ff;
        }

        .nav-item i {
            margin-right: 1rem;
            width: 20px;
            color: #00d4ff;
        }

        .nav-item .badge {
            position: absolute;
            right: 1rem;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border-radius: 10px;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .nav-item .ai-indicator {
            position: absolute;
            right: 1rem;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 0.75rem 1rem;
            width: 400px;
        }

        .search-bar input {
            background: none;
            border: none;
            color: white;
            outline: none;
            margin-left: 0.5rem;
            width: 100%;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* AI Status Indicator */
        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .ai-status.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
        }

        .ai-status.limited {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .ai-status.offline {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
        }

        /* Cards */
        .card {
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.1);
        }

        .card.ai-enhanced {
            border: 1px solid rgba(0, 255, 136, 0.2);
            background: linear-gradient(135deg, rgba(15, 15, 25, 0.8), rgba(0, 255, 136, 0.05));
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
        }

        .stat-card.ai-card::before {
            background: linear-gradient(90deg, #00ff88, #00d4ff);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-value.ai-value {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .stat-trend {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .trend-up {
            color: #00ff88;
        }

        .trend-down {
            color: #ff6b6b;
        }

        /* AI Insights Panel */
        .ai-insights-panel {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(0, 212, 255, 0.05));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .ai-insights-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .ai-brain-icon {
            color: #00ff88;
            animation: pulse 2s infinite;
        }

        .priority-lead {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .priority-lead:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .priority-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .priority-score {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .score-high {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .score-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .score-low {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .ai-reasoning {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
        }

        .suggested-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-tag {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Data Quality Monitor */
        .quality-monitor {
            background: rgba(15, 15, 25, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .quality-score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            position: relative;
        }

        .quality-excellent {
            background: conic-gradient(#00ff88 0deg, #00ff88 324deg, rgba(255,255,255,0.1) 324deg);
        }

        .quality-good {
            background: conic-gradient(#00d4ff 0deg, #00d4ff 288deg, rgba(255,255,255,0.1) 288deg);
        }

        .quality-fair {
            background: conic-gradient(#ffc107 0deg, #ffc107 216deg, rgba(255,255,255,0.1) 216deg);
        }

        .quality-poor {
            background: conic-gradient(#ff6b6b 0deg, #ff6b6b 144deg, rgba(255,255,255,0.1) 144deg);
        }

        .quality-issues {
            margin-top: 1rem;
        }

        .quality-issue {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Smart Actions */
        .smart-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .smart-action-btn {
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            border: none;
            border-radius: 15px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .smart-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }

        .smart-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .smart-action-btn.ai-action {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            border: none;
            border-radius: 15px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-ai {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        /* Tables */
        .table-container {
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            background: rgba(0, 212, 255, 0.1);
            font-weight: 600;
            color: #00d4ff;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .lead-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .lead-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .lead-card.ai-enhanced {
            border-left: 4px solid #00ff88;
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .lead-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .lead-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ai-insights-badge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-new { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .status-contacted { background: rgba(0, 123, 255, 0.2); color: #007bff; }
        .status-qualified { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .status-converted { background: rgba(25, 135, 84, 0.2); color: #198754; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .close-btn:hover {
            opacity: 1;
        }

        /* Auth Forms */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
        }

        .auth-card {
            background: rgba(15, 15, 25, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 3rem;
            width: 400px;
            text-align: center;
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Processing Indicator */
        .ai-processing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .ai-processing .spinner {
            width: 16px;
            height: 16px;
            border-width: 2px;
            border-top-color: #00ff88;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .search-bar {
                width: 100%;
            }

            .smart-actions {
                flex-direction: column;
            }

            .priority-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';

        // Auth Context
        const AuthContext = createContext();

        const useAuth = () => {
            const context = useContext(AuthContext);
            if (!context) {
                throw new Error('useAuth must be used within an AuthProvider');
            }
            return context;
        };

        // API Helper with AI endpoints
        const api = {
            async request(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { Authorization: `Bearer ${token}` }),
                    },
                    ...options,
                };

                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Network error' }));
                    throw new Error(error.detail || 'Request failed');
                }

                return response.json();
            },

            async get(endpoint) {
                return this.request(endpoint);
            },

            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
            },

            async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data),
                });
            },

            async delete(endpoint) {
                return this.request(endpoint, {
                    method: 'DELETE',
                });
            },

            async login(username, password) {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Login failed' }));
                    throw new Error(error.detail || 'Login failed');
                }

                return response.json();
            },

            // AI-specific endpoints
            async getAIInsights(leadId) {
                return this.get(`/leads/${leadId}/ai-insights`);
            },

            async getDataQuality(leadId) {
                return this.get(`/leads/${leadId}/data-quality`);
            },

            async batchAnalyze(options = {}) {
                return this.post('/leads/analyze-batch', options);
            },

            async getAIStatus() {
                return this.get('/ai/status');
            },

            async getAIDashboard() {
                return this.get('/ai/dashboard');
            },

            async findSimilarLeads(leadId, options = {}) {
                return this.post('/ai/similar-leads', { reference_lead_id: leadId, ...options });
            },

            async detectDuplicates(options = {}) {
                return this.post('/ai/detect-duplicates', options);
            }
        };

        // Auth Provider
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    api.get('/auth/me')
                        .then(setUser)
                        .catch(() => localStorage.removeItem('token'))
                        .finally(() => setLoading(false));
                } else {
                    setLoading(false);
                }
            }, []);

            const login = async (username, password) => {
                const { access_token } = await api.login(username, password);
                localStorage.setItem('token', access_token);
                const userData = await api.get('/auth/me');
                setUser(userData);
                return userData;
            };

            const register = async (email, username, password) => {
                await api.post('/auth/register', { email, username, password });
                return login(username, password);
            };

            // Continue from the previous artifact...

        const logout = () => {
            localStorage.removeItem('token');
            setUser(null);
        };

        return (
            <AuthContext.Provider value={{ user, login, register, logout, loading }}>
                {children}
            </AuthContext.Provider>
        );
    };

    // AI Status Hook
    // FIXED VERSION: AI Status Hook
const useAIStatus = () => {
    const [aiStatus, setAIStatus] = useState('checking');
    const [aiMetrics, setAIMetrics] = useState(null);

    useEffect(() => {
        const checkAIStatus = async () => {
            try {
                const status = await api.getAIStatus();
                
                // FIX: Use correct field name and map status values
                let mappedStatus = 'offline'; // default
                
                if (status.system_status) {
                    // Map backend status to frontend status
                    switch (status.system_status) {
                        case 'healthy':
                            mappedStatus = 'operational';
                            break;
                        case 'degraded':
                            mappedStatus = 'limited';
                            break;
                        case 'critical':
                        default:
                            mappedStatus = 'offline';
                            break;
                    }
                }
                
                setAIStatus(mappedStatus);
                setAIMetrics(status);
                
                console.log('AI Status Check:', {
                    rawStatus: status.system_status,
                    mappedStatus: mappedStatus,
                    activeModels: status.active_models
                });
                
            } catch (error) {
                console.error('AI Status check failed:', error);
                setAIStatus('offline');
            }
        };

        checkAIStatus();
        const interval = setInterval(checkAIStatus, 30000); // Check every 30 seconds
        return () => clearInterval(interval);
    }, []);

    return { aiStatus, aiMetrics };
};
    // Components
    const LoadingSpinner = () => (
        <div className="loading">
            <div className="spinner"></div>
        </div>
    );

 const AIStatusIndicator = ({ status }) => {
    const getStatusText = () => {
        switch (status) {
            case 'operational': return 'âœ¨ AI Active';
            case 'limited': return 'âš ï¸ AI Limited';
            case 'checking': return 'ðŸ”„ Checking...';
            default: return 'âŒ AI Offline';
        }
    };

    const getStatusClass = () => {
        switch (status) {
            case 'operational': return 'ai-status-active';
            case 'limited': return 'ai-status-warning';
            case 'checking': return 'ai-status-processing';
            default: return 'ai-status-offline';
        }
    };

    return (
        <div className={`ai-status-indicator ${getStatusClass()}`}>
            <i className="fas fa-brain"></i>
            {getStatusText()}
        </div>
    );
};

    const AIInsightsPanel = ({ leads = [] }) => {
        const [insights, setInsights] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const loadAIInsights = async () => {
                try {
                    const response = await api.getAIDashboard();
                    setInsights(response.recent_insights || []);
                } catch (error) {
                    console.error('Error loading AI insights:', error);
                } finally {
                    setLoading(false);
                }
            };

            loadAIInsights();
        }, []);

        const getPriorityClass = (score) => {
            if (score >= 80) return 'score-high';
            if (score >= 60) return 'score-medium';
            return 'score-low';
        };

        const getScoreText = (score) => {
            return ''
        };

        if (loading) return <LoadingSpinner />;

        return (
            <div className="ai-insights-panel fade-in">
                <div className="ai-insights-header">
                    <div className="ai-insights-title">
                        <i className="fas fa-brain ai-brain-icon"></i>
                        AI Lead Insights
                    </div>
                    <button className="smart-action-btn ai-action" onClick={() => api.batchAnalyze()}>
                        <i className="fas fa-sync"></i>
                        Refresh Insights
                    </button>
                </div>

                {insights.length === 0 ? (
                    <div style={{textAlign: 'center', padding: '2rem', opacity: 0.7}}>
                        <i className="fas fa-lightbulb" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                        <p>No AI insights available yet. Add some leads to get started!</p>
                    </div>
                ) : (
                    insights.slice(0, 5).map((insight, index) => (
                        <div key={index} className="priority-lead slide-in">
                            <div className="priority-header">
                                <div>
                                    <div className="lead-name">{insight.lead_name || `Lead #${insight.lead_id}`}</div>
                                    <div style={{fontSize: '0.9rem', opacity: 0.8}}>{insight.company_name}</div>
                                </div>
                                
                            </div>
                            <div className="ai-reasoning">
                                <i className="fas fa-lightbulb" style={{marginRight: '0.5rem', color: '#00ff88'}}></i>
                                {insight.priority_reason || 'High-quality lead with strong conversion potential'}
                            </div>
                            <div className="suggested-actions">
                                {(insight.suggested_actions || ['Contact immediately', 'Prepare proposal']).map((action, i) => (
                                    <span key={i} className="action-tag">{action}</span>
                                ))}
                            </div>
                        </div>
                    ))
                )}
            </div>
        );
    };

    const DataQualityMonitor = () => {
        const [qualityData, setQualityData] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const loadQualityData = async () => {
                try {
                    const response = await api.get('/ai/quality-report');
                    setQualityData(response);
                } catch (error) {
                    console.error('Error loading quality data:', error);
                } finally {
                    setLoading(false);
                }
            };

            loadQualityData();
        }, []);

        if (loading) return <LoadingSpinner />;

        const getQualityClass = (score) => {
            if (score >= 85) return 'quality-excellent';
            if (score >= 70) return 'quality-good';
            if (score >= 50) return 'quality-fair';
            return 'quality-poor';
        };

        const score = qualityData?.overall_score || 75;

        return (
            <div className="quality-monitor fade-in">
                <h3 style={{marginBottom: '1.5rem', textAlign: 'center'}}>
                    <i className="fas fa-chart-line" style={{marginRight: '0.5rem', color: '#00d4ff'}}></i>
                    Data Quality Score
                </h3>
                
                <div className={`quality-score-circle ${getQualityClass(score)}`}>
                    <span>{Math.round(score)}%</span>
                </div>

                <div className="quality-issues">
                    <h4 style={{marginBottom: '1rem', fontSize: '1rem'}}>Recent Improvements:</h4>
                    {(qualityData?.recent_improvements || [
                        'Fixed 12 duplicate entries',
                        'Validated 45 email addresses',
                        'Enriched 23 company profiles'
                    ]).map((improvement, index) => (
                        <div key={index} className="quality-issue">
                            <i className="fas fa-check-circle" style={{color: '#00ff88'}}></i>
                            {improvement}
                        </div>
                    ))}
                </div>

                <div className="smart-actions">
                    <button className="smart-action-btn" onClick={() => api.detectDuplicates()}>
                        <i className="fas fa-search"></i>
                        Find Duplicates
                    </button>
                    <button className="smart-action-btn secondary">
                        <i className="fas fa-tools"></i>
                        Clean Data
                    </button>
                </div>
            </div>
        );
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal" onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h2>{title}</h2>
                        <button className="close-btn" onClick={onClose}>
                            <i className="fas fa-times"></i>
                        </button>
                    </div>
                    {children}
                </div>
            </div>
        );
    };

    const Sidebar = ({ activeTab, setActiveTab }) => {
        const { user, logout } = useAuth();
        const { aiStatus } = useAIStatus();

        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-chart-line', aiEnhanced: true },
            { id: 'leads', label: 'Leads', icon: 'fas fa-users', aiEnhanced: true },
            { id: 'companies', label: 'Companies', icon: 'fas fa-building' },
            { id: 'campaigns', label: 'Campaigns', icon: 'fas fa-bullhorn' },
            { id: 'scraper', label: 'Lead Scraper', icon: 'fas fa-search', aiEnhanced: true },
            { id: 'analytics', label: 'Analytics', icon: 'fas fa-chart-bar', aiEnhanced: true },
            { id: 'ai-insights', label: 'AI Insights', icon: 'fas fa-brain', isNew: true },
        ];

        return (
            <div className="sidebar">
                <div className="logo">
                    <h1><i className="fas fa-rocket"></i> LeadGen Pro</h1>
                    <AIStatusIndicator status={aiStatus} />
                </div>
                <nav>
                    {navItems.map(item => (
                        <div
                            key={item.id}
                            className={`nav-item ${activeTab === item.id ? 'active' : ''}`}
                            onClick={() => setActiveTab(item.id)}
                        >
                            <i className={item.icon}></i>
                            <span>{item.label}</span>
                            {item.aiEnhanced && <div className="ai-indicator" title="AI Enhanced"></div>}
                            {item.isNew && <div className="badge">NEW</div>}
                        </div>
                    ))}
                    <div className="nav-item" onClick={logout} style={{marginTop: '2rem', borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: '2rem'}}>
                        <i className="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </nav>
            </div>
        );
    };

    const Header = ({ user }) => {
        const { aiStatus, aiMetrics } = useAIStatus();

        return (
            <div className="header">
                <div className="search-bar">
                    <i className="fas fa-search"></i>
                    <input type="text" placeholder="Search leads, companies, or ask AI..." />
                </div>
                <div className="user-profile">
                    <AIStatusIndicator status={aiStatus} />
                    <span>Welcome back, {user?.username}!</span>
                    <div className="avatar">
                        {user?.username?.[0]?.toUpperCase()}
                    </div>
                </div>
            </div>
        );
    };

const Dashboard = ({ navigateToLead, handleAIAction, setActiveTab }) => {
    const [stats, setStats] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadDashboardData();
    }, []);

    const loadDashboardData = async () => {
        try {
            const analyticsData = await api.get('/analytics/dashboard?include_ai_metrics=true');
            console.log('ðŸ“Š Dashboard data loaded:', analyticsData);
            setStats(analyticsData);
        } catch (error) {
            console.error('âŒ Dashboard loading failed:', error);
        } finally {
            setLoading(false);
        }
    };

    // Calculate conversion rate (assuming some leads have status like 'converted', 'qualified', etc.)
    const getConversionRate = () => {
        if (!stats?.lead_statuses) return 0;
        
        const totalLeads = stats.overview.total_leads;
        const convertedLeads = stats.lead_statuses
            .filter(status => ['converted', 'qualified', 'closed_won'].includes(status.status?.toLowerCase()))
            .reduce((sum, status) => sum + status.count, 0);
        
        return totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0;
    };

    // Calculate this week's growth
    const getWeeklyGrowth = () => {
        const recentLeads = stats?.overview?.recent_leads || 0;
        const totalLeads = stats?.overview?.total_leads || 0;
        const previousWeekLeads = totalLeads - recentLeads;
        
        if (previousWeekLeads === 0) return recentLeads > 0 ? 100 : 0;
        return ((recentLeads / previousWeekLeads) * 100).toFixed(1);
    };

    // Get most popular source
    const getTopSource = () => {
        if (!stats?.lead_sources || stats.lead_sources.length === 0) {
            return { name: 'No data', count: 0 };
        }
        
        const topSource = stats.lead_sources.reduce((max, source) => 
            source.count > max.count ? source : max
        );
        
        return {
            name: topSource.source || 'Unknown',
            count: topSource.count,
            percentage: ((topSource.count / stats.overview.total_leads) * 100).toFixed(1)
        };
    };

    // Calculate engagement score (based on recent activity)
    const getEngagementScore = () => {
        const totalLeads = stats?.overview?.total_leads || 0;
        const recentLeads = stats?.overview?.recent_leads || 0;
        const activeCampaigns = stats?.overview?.total_campaigns || 0;
        
        if (totalLeads === 0) return 0;
        
        // Simple engagement calculation based on recent activity and campaign activity
        const recentActivityRate = (recentLeads / totalLeads) * 100;
        const campaignDensity = activeCampaigns > 0 ? Math.min((activeCampaigns / 10) * 100, 100) : 0;
        
        return Math.round((recentActivityRate * 0.7 + campaignDensity * 0.3));
    };

    if (loading) return <LoadingSpinner />;

    const conversionRate = getConversionRate();
    const weeklyGrowth = getWeeklyGrowth();
    const topSource = getTopSource();
    const engagementScore = getEngagementScore();

    return (
        <div className="fade-in">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h1 style={{fontSize: '2.5rem', fontWeight: 'bold', margin: 0}}>
                    <i className="fas fa-chart-line" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                    Business Dashboard
                </h1>
                <button 
                    className="btn btn-ai"
                    onClick={loadDashboardData}
                    disabled={loading}
                >
                    <i className="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>
            
            {stats && (
                <div className="stats-grid" style={{marginBottom: '2rem'}}>
                    {/* Total Leads */}
                    <div className="stat-card">
                        <div className="stat-value">{stats.overview.total_leads.toLocaleString()}</div>
                        <div className="stat-label">Total Leads</div>
                        <div className="stat-trend trend-up">
                            <i className="fas fa-arrow-up"></i>
                            +{weeklyGrowth}% this week
                        </div>
                    </div>
                    
                    {/* Companies */}
                    <div className="stat-card">
                        <div className="stat-value">{stats.overview.total_companies.toLocaleString()}</div>
                        <div className="stat-label">Companies</div>
                        <div className="stat-trend trend-up">
                            <i className="fas fa-building"></i>
                            Database growing
                        </div>
                    </div>
                    
                    {/* REPLACED: Conversion Rate instead of AI High Priority */}
                    <div className="stat-card success-card">
                        <div className="stat-value success-value">{conversionRate}%</div>
                        <div className="stat-label">Conversion Rate</div>
                        <div className="stat-trend trend-success">
                            <i className="fas fa-chart-line"></i>
                            {conversionRate > 0 ? 'Converting leads' : 'Track conversions'}
                        </div>
                    </div>
                    
                    {/* REPLACED: Top Lead Source instead of Data Quality */}
                    <div className="stat-card primary-card">
                        <div className="stat-value primary-value">{topSource.percentage}%</div>
                        <div className="stat-label">Top Source: {topSource.name}</div>
                        <div className="stat-trend trend-primary">
                            <i className="fas fa-trophy"></i>
                            {topSource.count} leads from best source
                        </div>
                    </div>
                </div>
            )}

            {/* Enhanced Metrics Section */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginBottom: '2rem'}}>
                
                {/* Lead Sources Breakdown */}
                <div className="card">
                    <h2 style={{marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                        <i className="fas fa-pie-chart" style={{color: '#00d4ff'}}></i>
                        Lead Sources Performance
                    </h2>
                    
                    {stats.lead_sources && stats.lead_sources.length > 0 ? (
                        <div style={{display: 'grid', gap: '1rem'}}>
                            {stats.lead_sources.slice(0, 5).map((source, index) => {
                                const percentage = ((source.count / stats.overview.total_leads) * 100).toFixed(1);
                                return (
                                    <div key={index} style={{
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        padding: '1rem',
                                        background: 'rgba(255, 255, 255, 0.05)',
                                        borderRadius: '8px',
                                        border: '1px solid rgba(255, 255, 255, 0.1)'
                                    }}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            <div style={{
                                                width: '12px',
                                                height: '12px',
                                                borderRadius: '50%',
                                                background: index === 0 ? '#00ff88' : index === 1 ? '#00d4ff' : index === 2 ? '#7c3aed' : '#ff6b6b'
                                            }}></div>
                                            <span style={{textTransform: 'capitalize'}}>{source.source || 'Unknown'}</span>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontWeight: 'bold', color: '#00d4ff'}}>{source.count}</div>
                                            <div style={{fontSize: '0.8rem', opacity: 0.7}}>{percentage}%</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div style={{textAlign: 'center', padding: '2rem', opacity: 0.7}}>
                            <i className="fas fa-chart-pie" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                            <p>No source data available</p>
                        </div>
                    )}
                </div>

                {/* Engagement & Activity */}
                <div className="card">
                    <h2 style={{marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                        <i className="fas fa-pulse" style={{color: '#00ff88'}}></i>
                        Activity Overview
                    </h2>
                    
                    <div style={{display: 'grid', gap: '1.5rem'}}>
                        {/* Engagement Score */}
                        <div style={{
                            padding: '1.5rem',
                            background: 'rgba(0, 255, 136, 0.1)',
                            borderRadius: '8px',
                            border: '1px solid rgba(0, 255, 136, 0.3)',
                            textAlign: 'center'
                        }}>
                            <div style={{fontSize: '2rem', fontWeight: 'bold', color: '#00ff88', marginBottom: '0.5rem'}}>
                                {engagementScore}%
                            </div>
                            <div style={{opacity: 0.8}}>Engagement Score</div>
                            <div style={{fontSize: '0.8rem', opacity: 0.6, marginTop: '0.5rem'}}>
                                Based on recent activity and campaigns
                            </div>
                        </div>

                        {/* Quick Stats */}
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                            <div style={{textAlign: 'center', padding: '1rem', background: 'rgba(255, 255, 255, 0.05)', borderRadius: '6px'}}>
                                <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#00d4ff'}}>
                                    {stats.overview.recent_leads}
                                </div>
                                <div style={{fontSize: '0.8rem', opacity: 0.7}}>This Week</div>
                            </div>
                            
                            <div style={{textAlign: 'center', padding: '1rem', background: 'rgba(255, 255, 255, 0.05)', borderRadius: '6px'}}>
                                <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#7c3aed'}}>
                                    {stats.overview.total_campaigns}
                                </div>
                                <div style={{fontSize: '0.8rem', opacity: 0.7}}>Active Campaigns</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* AI Insights Panel (if available) */}
            <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem', marginBottom: '2rem'}}>
                <AIInsightsPanel />
                <DataQualityMonitor />
            </div>

            {/* Action Center */}
            <div className="card ai-enhanced">
                <h2 style={{marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                    <i className="fas fa-rocket" style={{color: '#00ff88'}}></i>
                    Quick Actions
                </h2>
                <div className="smart-actions">
                    <button 
                        className="smart-action-btn ai-action"
                        onClick={() => navigateToLead && navigateToLead(null)}
                    >
                        <i className="fas fa-users"></i>
                        View All Leads
                    </button>
                    
                    <button 
                        className="smart-action-btn ai-action"
                        onClick={() => {
                            if (setActiveTab) {
                                setActiveTab('analytics');
                            } else {
                                alert('Navigation not available. Please use the sidebar to go to Analytics.');
                            }
                        }}
                    >
                        <i className="fas fa-chart-bar"></i>
                        Detailed Analytics
                    </button>
                    
                    <button 
                        className="smart-action-btn ai-action"
                        onClick={() => {
                            if (setActiveTab) {
                                setActiveTab('ai-insights');
                            } else {
                                alert('Navigation not available. Please use the sidebar to go to AI Insights.');
                            }
                        }}
                    >
                        <i className="fas fa-brain"></i>
                        AI Insights
                    </button>
                    
                    <button 
                        className="smart-action-btn secondary"
                        onClick={async () => {
                            try {
                                // Create comprehensive export data
                                const exportData = {
                                    dashboard_summary: {
                                        total_leads: stats.overview.total_leads,
                                        total_companies: stats.overview.total_companies,
                                        total_campaigns: stats.overview.total_campaigns,
                                        recent_leads: stats.overview.recent_leads,
                                        conversion_rate: `${getConversionRate()}%`,
                                        weekly_growth: `${getWeeklyGrowth()}%`,
                                        engagement_score: `${getEngagementScore()}%`
                                    },
                                    lead_sources: stats.lead_sources?.map(source => ({
                                        source: source.source || 'Unknown',
                                        count: source.count,
                                        percentage: `${((source.count / stats.overview.total_leads) * 100).toFixed(1)}%`
                                    })) || [],
                                    lead_statuses: stats.lead_statuses?.map(status => ({
                                        status: status.status,
                                        count: status.count,
                                        percentage: `${((status.count / stats.overview.total_leads) * 100).toFixed(1)}%`
                                    })) || [],
                                    top_campaigns: stats.top_campaigns?.map(campaign => ({
                                        name: campaign.name,
                                        leads_count: campaign.leads_count
                                    })) || [],
                                    top_source_performance: {
                                        source: getTopSource().name,
                                        count: getTopSource().count,
                                        percentage: `${getTopSource().percentage}%`
                                    },
                                    export_metadata: {
                                        exported_at: new Date().toISOString(),
                                        exported_by: 'Dashboard Export',
                                        data_format: 'JSON',
                                        total_records: stats.overview.total_leads
                                    }
                                };
                                
                                // Create downloadable file
                                const jsonString = JSON.stringify(exportData, null, 2);
                                const blob = new Blob([jsonString], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                
                                // Create download link
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
                                link.style.display = 'none';
                                
                                // Trigger download
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                                
                                // Show success message
                                alert(`âœ… Dashboard data exported successfully!\n\nFile: dashboard-export-${new Date().toISOString().split('T')[0]}.json\nRecords: ${stats.overview.total_leads} leads\nFormat: JSON`);
                                
                            } catch (error) {
                                console.error('âŒ Export failed:', error);
                                alert(`âŒ Export failed: ${error.message}\n\nPlease try again or contact support if the issue persists.`);
                            }
                        }}
                    >
                        <i className="fas fa-download"></i>
                        Export Data
                    </button>
                </div>
            </div>

            {/* Top Campaigns */}
            {stats?.top_campaigns && stats.top_campaigns.length > 0 && (
                <div className="card" style={{marginTop: '2rem'}}>
                    <h2 style={{marginBottom: '1rem'}}>
                        <i className="fas fa-trophy" style={{marginRight: '0.5rem', color: '#ffc107'}}></i>
                        Top Performing Campaigns
                    </h2>
                    <div style={{display: 'grid', gap: '1rem'}}>
                        {stats.top_campaigns.map((campaign, index) => (
                            <div key={index} style={{
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center', 
                                padding: '1rem',
                                background: 'rgba(255, 255, 255, 0.05)',
                                borderRadius: '8px',
                                border: '1px solid rgba(255, 255, 255, 0.1)'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                                    <div style={{
                                        background: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#00d4ff',
                                        color: '#000',
                                        width: '24px',
                                        height: '24px',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '0.8rem',
                                        fontWeight: 'bold'
                                    }}>
                                        {index + 1}
                                    </div>
                                    <span style={{fontWeight: 'bold'}}>{campaign.name}</span>
                                </div>
                                <span style={{color: '#00d4ff', fontWeight: 'bold'}}>
                                    {campaign.leads_count} leads
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};
const LeadsPage = ({ navigateToLead, setActiveTab }) => {
    const [leads, setLeads] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedLeads, setSelectedLeads] = useState([]);
    const [showModal, setShowModal] = useState(false);
    const [editLead, setEditLead] = useState(null);
    const [campaigns, setCampaigns] = useState([]);
    const [analyzingLeads, setAnalyzingLeads] = useState(new Set()); // Track which leads are being analyzed
    const [formData, setFormData] = useState({
        first_name: '',
        last_name: '',
        email: '',
        phone: '',
        title: '',
        linkedin_url: '',
        source: 'manual',
        campaign_id: ''
    });

    useEffect(() => {
        loadLeads();
        loadCampaigns();
    }, []);

    const loadLeads = async () => {
        try {
            setLoading(true);
            const response = await api.get('/leads');
            setLeads(response);
        } catch (error) {
            console.error('Error loading leads:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadCampaigns = async () => {
        try {
            const response = await api.get('/campaigns');
            setCampaigns(response);
        } catch (error) {
            console.error('Error loading campaigns:', error);
        }
    };

    // UPDATED: Individual lead analysis function using existing endpoint
    const handleAnalyzeLead = async (leadId) => {
        setAnalyzingLeads(prev => new Set([...prev, leadId]));
        try {
            // Call existing individual lead analysis endpoint
            const result = await api.getAIInsights(leadId, { force_refresh: true });
            alert(`Analysis completed! Priority: ${result.priority_level || 'Unknown'}`);
            
            // Optionally navigate to AI insights page
            if (setActiveTab) {
                setActiveTab('ai-insights');
            }
        } catch (error) {
            alert('Analysis failed: ' + error.message);
        } finally {
            setAnalyzingLeads(prev => {
                const newSet = new Set(prev);
                newSet.delete(leadId);
                return newSet;
            });
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const submitData = {
                ...formData,
                campaign_id: formData.campaign_id ? parseInt(formData.campaign_id) : null
            };
            
            if (editLead) {
                await api.put(`/leads/${editLead.id}`, submitData);
            } else {
                await api.post('/leads', submitData);
            }
            setShowModal(false);
            setEditLead(null);
            setFormData({
                first_name: '',
                last_name: '',
                email: '',
                phone: '',
                title: '',
                linkedin_url: '',
                source: 'manual',
                campaign_id: ''
            });
            loadLeads();
        } catch (error) {
            alert('Error saving lead: ' + error.message);
        }
    };

    const handleEdit = (lead) => {
        setEditLead(lead);
        setFormData({
            first_name: lead.first_name || '',
            last_name: lead.last_name || '',
            email: lead.email || '',
            phone: lead.phone || '',
            title: lead.title || '',
            linkedin_url: lead.linkedin_url || '',
            source: lead.source || 'manual',
            campaign_id: lead.campaign_id || ''
        });
        setShowModal(true);
    };

    const handleDelete = async (leadId) => {
        if (confirm('Are you sure you want to delete this lead?')) {
            try {
                await api.delete(`/leads/${leadId}`);
                loadLeads();
            } catch (error) {
                alert('Error deleting lead: ' + error.message);
            }
        }
    };

    const handleBulkCampaignAssignment = async () => {
        if (selectedLeads.length === 0) {
            alert('Please select leads first');
            return;
        }
        
        const campaignId = prompt('Enter campaign ID to assign selected leads (or leave empty to remove campaign):');
        if (campaignId === null) return; // User cancelled
        
        try {
            for (const leadId of selectedLeads) {
                await api.put(`/leads/${leadId}`, { 
                    campaign_id: campaignId ? parseInt(campaignId) : null 
                });
            }
            alert(`Updated ${selectedLeads.length} leads`);
            setSelectedLeads([]);
            loadLeads();
        } catch (error) {
            alert('Error updating leads: ' + error.message);
        }
    };

    if (loading) return <LoadingSpinner />;

    return (
        <div className="fade-in">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h1 style={{fontSize: '2.5rem', fontWeight: 'bold'}}>
                    <i className="fas fa-users" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                    Leads ({leads.length})
                </h1>
                <button className="btn" onClick={() => setShowModal(true)}>
                    <i className="fas fa-plus"></i> Add Lead
                </button>
            </div>

            {/* UPDATED: Simplified Bulk Actions - Removed AI Analysis */}
            {selectedLeads.length > 0 && (
                <div className="bulk-actions" style={{marginBottom: '1rem', padding: '1rem', background: 'rgba(0, 212, 255, 0.1)', borderRadius: '10px'}}>
                    <div style={{display: 'flex', gap: '1rem', alignItems: 'center'}}>
                        <span style={{fontWeight: 'bold'}}>{selectedLeads.length} selected</span>
                        <button className="btn btn-secondary" onClick={handleBulkCampaignAssignment}>
                            <i className="fas fa-bullhorn"></i> Assign to Campaign
                        </button>
                        <button className="btn btn-outline" onClick={() => setSelectedLeads([])}>
                            <i className="fas fa-times"></i> Clear Selection
                        </button>
                    </div>
                </div>
            )}

            {/* Quick Actions */}
            <div style={{marginBottom: '2rem'}}>
                <div className="smart-actions">
                    <button 
                        className="btn btn-ai"
                        onClick={() => setActiveTab('ai-insights')}
                    >
                        <i className="fas fa-brain"></i>
                        View AI Insights
                    </button>
                    <button 
                        className="btn btn-secondary"
                        onClick={() => setActiveTab('scraper')}
                    >
                        <i className="fas fa-search"></i>
                        Scrape More Leads
                    </button>
                </div>
            </div>

            {/* Leads List */}
            <div style={{display: 'grid', gap: '1rem'}}>
                {leads.map(lead => (
                    <div 
                        key={lead.id} 
                        className="card lead-card" 
                        style={{
                            background: selectedLeads.includes(lead.id) ? 'rgba(0, 212, 255, 0.1)' : 'rgba(30, 30, 40, 0.7)',
                            border: selectedLeads.includes(lead.id) ? '2px solid rgba(0, 212, 255, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)'
                        }}
                    >
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                            {/* Lead Info */}
                            <div style={{flex: 1}}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem'}}>
                                    <input
                                        type="checkbox"
                                        checked={selectedLeads.includes(lead.id)}
                                        onChange={(e) => {
                                            if (e.target.checked) {
                                                setSelectedLeads([...selectedLeads, lead.id]);
                                            } else {
                                                setSelectedLeads(selectedLeads.filter(id => id !== lead.id));
                                            }
                                        }}
                                        style={{marginRight: '0.5rem'}}
                                    />
                                    <h3 style={{margin: 0, fontSize: '1.2rem'}}>
                                        {lead.first_name} {lead.last_name}
                                    </h3>
                                    {lead.score && (
                                        <span className={`score-badge ${lead.score >= 80 ? 'score-high' : lead.score >= 60 ? 'score-medium' : 'score-low'}`}>
                                            Score: {lead.score}
                                        </span>
                                    )}
                                </div>

                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem'}}>
                                    <div>
                                        <strong>Email:</strong> <a href={`mailto:${lead.email}`} style={{color: '#00d4ff'}}>{lead.email}</a>
                                    </div>
                                    <div>
                                        <strong>Phone:</strong> {lead.phone || 'Not provided'}
                                    </div>
                                    <div>
                                        <strong>Title:</strong> {lead.title || 'Not specified'}
                                    </div>
                                    <div>
                                        <strong>Company:</strong> {
                                            lead.company?.name || 
                                            lead.company_name || 
                                            'Not specified'
                                        }
                                    </div>
                                </div>

                                {lead.source && (
                                    <div style={{marginBottom: '1rem'}}>
                                        <span className="source-badge">{lead.source}</span>
                                        {lead.campaign_name && (
                                            <span className="campaign-badge" style={{marginLeft: '0.5rem'}}>{lead.campaign_name}</span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* UPDATED: Lead Actions with Individual Analyze Button */}
                            <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem', minWidth: '120px'}}>
                                <button 
                                    className={`analyze-btn ${analyzingLeads.has(lead.id) ? 'analyzing' : ''}`}
                                    onClick={() => handleAnalyzeLead(lead.id)}
                                    disabled={analyzingLeads.has(lead.id)}
                                    style={{
                                        background: analyzingLeads.has(lead.id) 
                                            ? 'linear-gradient(135deg, #ff9500, #ff7700)' 
                                            : 'linear-gradient(135deg, #00d4ff, #0099cc)',
                                        color: 'white',
                                        border: 'none',
                                        padding: '0.5rem 1rem',
                                        borderRadius: '6px',
                                        cursor: analyzingLeads.has(lead.id) ? 'not-allowed' : 'pointer',
                                        fontSize: '0.85rem',
                                        fontWeight: '600',
                                        transition: 'all 0.3s ease',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem'
                                    }}
                                >
                                    {analyzingLeads.has(lead.id) ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i>
                                            Analyzing...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-brain"></i>
                                            Analyze
                                        </>
                                    )}
                                </button>

                                <button 
                                    className="btn btn-sm btn-secondary" 
                                    onClick={() => handleEdit(lead)}
                                    style={{fontSize: '0.8rem'}}
                                >
                                    <i className="fas fa-edit"></i> Edit
                                </button>

                                <button 
                                    className="btn btn-sm btn-danger" 
                                    onClick={() => handleDelete(lead.id)}
                                    style={{fontSize: '0.8rem'}}
                                >
                                    <i className="fas fa-trash"></i> Delete
                                </button>

                                {lead.linkedin_url && (
                                    <a 
                                        href={lead.linkedin_url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="btn btn-sm btn-outline"
                                        style={{fontSize: '0.8rem', textAlign: 'center'}}
                                    >
                                        <i className="fab fa-linkedin"></i> LinkedIn
                                    </a>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {leads.length === 0 && (
                <div style={{textAlign: 'center', padding: '4rem', opacity: 0.7}}>
                    <i className="fas fa-users" style={{fontSize: '4rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                    <h3>No leads yet</h3>
                    <p>Start by adding your first lead or importing leads from other sources.</p>
                    <div style={{display: 'flex', gap: '1rem', justifyContent: 'center', marginTop: '2rem'}}>
                        <button className="btn btn-primary" onClick={() => setShowModal(true)}>
                            <i className="fas fa-plus"></i> Add Lead
                        </button>
                        <button className="btn btn-secondary" onClick={() => setActiveTab('scraper')}>
                            <i className="fas fa-search"></i> Scrape Leads
                        </button>
                    </div>
                </div>
            )}

            {/* Lead Form Modal - No changes needed */}
            {showModal && (
                <div className="modal">
                    <div className="modal-content">
                        <h2>{editLead ? 'Edit Lead' : 'Add New Lead'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                                <input
                                    type="text"
                                    placeholder="First Name *"
                                    value={formData.first_name}
                                    onChange={(e) => setFormData({...formData, first_name: e.target.value})}
                                    required
                                />
                                <input
                                    type="text"
                                    placeholder="Last Name *"
                                    value={formData.last_name}
                                    onChange={(e) => setFormData({...formData, last_name: e.target.value})}
                                    required
                                />
                                <input
                                    type="email"
                                    placeholder="Email *"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                                <input
                                    type="tel"
                                    placeholder="Phone"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                />
                                <input
                                    type="text"
                                    placeholder="Job Title"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                />
                                <input
                                    type="url"
                                    placeholder="LinkedIn URL"
                                    value={formData.linkedin_url}
                                    onChange={(e) => setFormData({...formData, linkedin_url: e.target.value})}
                                />
                                <select
                                    value={formData.source}
                                    onChange={(e) => setFormData({...formData, source: e.target.value})}
                                >
                                    <option value="manual">Manual</option>
                                    <option value="import">Import</option>
                                    <option value="scraper">Web Scraper</option>
                                    <option value="referral">Referral</option>
                                    <option value="social_media">Social Media</option>
                                </select>
                                <select
                                    value={formData.campaign_id}
                                    onChange={(e) => setFormData({...formData, campaign_id: e.target.value})}
                                >
                                    <option value="">No Campaign</option>
                                    {campaigns.map(campaign => (
                                        <option key={campaign.id} value={campaign.id}>
                                            {campaign.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div style={{display: 'flex', gap: '1rem', marginTop: '2rem'}}>
                                <button type="submit" className="btn">
                                    {editLead ? 'Update Lead' : 'Add Lead'}
                                </button>
                                <button 
                                    type="button" 
                                    className="btn btn-secondary" 
                                    onClick={() => {
                                        setShowModal(false);
                                        setEditLead(null);
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};

    const CompaniesPage = () => {
        // Existing companies page code remains the same
        const [companies, setCompanies] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showModal, setShowModal] = useState(false);
        const [formData, setFormData] = useState({
            name: '',
            domain: '',
            industry: '',
            size: '',
            location: '',
            website: ''
        });

        useEffect(() => {
            loadCompanies();
        }, []);

        const loadCompanies = async () => {
            try {
                const data = await api.get('/companies');
                setCompanies(data);
            } catch (error) {
                console.error('Error loading companies:', error);
            } finally {
                setLoading(false);
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                await api.post('/companies', formData);
                setShowModal(false);
                setFormData({
                    name: '',
                    domain: '',
                    industry: '',
                    size: '',
                    location: '',
                    website: ''
                });
                loadCompanies();
            } catch (error) {
                alert('Error saving company: ' + error.message);
            }
        };

        if (loading) return <LoadingSpinner />;

        return (
            <div className="fade-in">
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                    <h1 style={{fontSize: '2.5rem', fontWeight: 'bold'}}>
                        <i className="fas fa-building" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                        Companies ({companies.length})
                    </h1>
                    <button className="btn" onClick={() => setShowModal(true)}>
                        <i className="fas fa-plus"></i> Add Company
                    </button>
                </div>

                <div className="table-container">
                    <table className="table">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Domain</th>
                                <th>Industry</th>
                                <th>Size</th>
                                <th>Location</th>
                                <th>Website</th>
                            </tr>
                        </thead>
                        <tbody>
                            {companies.map(company => (
                                <tr key={company.id}>
                                    <td style={{fontWeight: 'bold'}}>{company.name}</td>
                                    <td>{company.domain || '-'}</td>
                                    <td>{company.industry || '-'}</td>
                                    <td>{company.size || '-'}</td>
                                    <td>{company.location || '-'}</td>
                                    <td>
                                        {company.website ? (
                                            <a href={company.website} target="_blank" rel="noopener noreferrer" style={{color: '#00d4ff'}}>
                                                <i className="fas fa-external-link-alt"></i>
                                            </a>
                                        ) : '-'}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {companies.length === 0 && (
                        <div style={{textAlign: 'center', padding: '3rem', opacity: 0.7}}>
                            No companies found. Start by adding your first company!
                        </div>
                    )}
                </div>

                <Modal 
                    isOpen={showModal} 
                    onClose={() => setShowModal(false)} 
                    title="Add New Company"
                >
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label className="form-label">Company Name</label>
                            <input 
                                className="form-input"
                                type="text"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                required
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Domain</label>
                            <input 
                                className="form-input"
                                type="text"
                                placeholder="example.com"
                                value={formData.domain}
                                onChange={(e) => setFormData({...formData, domain: e.target.value})}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Industry</label>
                            <select 
                                className="form-input"
                                value={formData.industry}
                                onChange={(e) => setFormData({...formData, industry: e.target.value})}
                            >
                                <option value="">Select Industry</option>
                                <option value="Technology">Technology</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Finance">Finance</option>
                                <option value="E-commerce">E-commerce</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Company Size</label>
                            <select 
                                className="form-input"
                                value={formData.size}
                                onChange={(e) => setFormData({...formData, size: e.target.value})}
                            >
                                <option value="">Select Size</option>
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-200">51-200 employees</option>
                                <option value="201-500">201-500 employees</option>
                                <option value="500+">500+ employees</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Location</label>
                            <input 
                                className="form-input"
                                type="text"
                                placeholder="City, Country"
                                value={formData.location}
                                onChange={(e) => setFormData({...formData, location: e.target.value})}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Website</label>
                            <input 
                                className="form-input"
                                type="url"
                                placeholder="https://example.com"
                                value={formData.website}
                                onChange={(e) => setFormData({...formData, website: e.target.value})}
                            />
                        </div>
                        <div style={{display: 'flex', gap: '1rem', marginTop: '2rem'}}>
                            <button type="submit" className="btn">
                                <i className="fas fa-save"></i> Add Company
                            </button>
                            <button 
                                type="button" 
                                className="btn btn-secondary" 
                                onClick={() => setShowModal(false)}
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </Modal>
            </div>
        );
    };

    const CampaignsPage = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [formData, setFormData] = useState({
        name: '',
        description: ''
    });

    useEffect(() => {
        loadCampaigns();
    }, []);

    const loadCampaigns = async () => {
        try {
            const data = await api.get('/campaigns');
            setCampaigns(data);
        } catch (error) {
            console.error('Error loading campaigns:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Validate required fields
        if (!formData.name.trim()) {
            alert('Campaign name is required');
            return;
        }
        
        try {
            const campaignData = {
                name: formData.name.trim(),
                description: formData.description.trim() || null
            };
            
            console.log('Creating campaign with data:', campaignData);
            
            await api.post('/campaigns', campaignData);
            
            // Reset form and close modal
            setShowModal(false);
            setFormData({
                name: '',
                description: ''
            });
            
            // Reload campaigns
            await loadCampaigns();
            
        } catch (error) {
            console.error('Campaign creation error:', error);
            const errorMessage = error.response?.data?.detail || error.message || 'Unknown error';
            alert(`Error creating campaign: ${errorMessage}`);
        }
    };

    if (loading) return <LoadingSpinner />;

    return (
        <div className="fade-in">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h1 style={{fontSize: '2.5rem', fontWeight: 'bold'}}>
                    <i className="fas fa-bullhorn" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                    Campaigns ({campaigns.length})
                </h1>
                <button className="btn" onClick={() => setShowModal(true)}>
                    <i className="fas fa-plus"></i> Create Campaign
                </button>
            </div>

            <div className="table-container">
                <table className="table">
                    <thead>
                        <tr>
                            <th>Campaign Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Leads Count</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {campaigns.map(campaign => (
                            <tr key={campaign.id}>
                                <td style={{fontWeight: 'bold'}}>{campaign.name}</td>
                                <td>{campaign.description || '-'}</td>
                                <td>
                                    <span className={`status-badge status-${campaign.status}`}>
                                        {campaign.status}
                                    </span>
                                </td>
                                <td>{campaign.leads_count || 0}</td>
                                <td>{new Date(campaign.created_at).toLocaleDateString()}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {campaigns.length === 0 && (
                    <div style={{textAlign: 'center', padding: '3rem', opacity: 0.7}}>
                        <i className="fas fa-bullhorn" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                        <h3 style={{marginBottom: '1rem'}}>No campaigns yet</h3>
                        <p>Create your first campaign to organize your leads by project or goal!</p>
                    </div>
                )}
            </div>

            <Modal 
                isOpen={showModal} 
                onClose={() => setShowModal(false)} 
                title="Create New Campaign"
            >
                <form onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label className="form-label">Campaign Name *</label>
                        <input 
                            className="form-input"
                            type="text"
                            placeholder="e.g., Q1 Enterprise Outreach, SaaS Demo Campaign"
                            value={formData.name}
                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                            required
                            maxLength={100}
                        />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Description</label>
                        <textarea 
                            className="form-input"
                            placeholder="Describe the goal and target audience for this campaign..."
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            rows="3"
                            maxLength={500}
                        />
                    </div>
                    <div style={{display: 'flex', gap: '1rem', marginTop: '2rem'}}>
                        <button type="submit" className="btn">
                            <i className="fas fa-save"></i> Create Campaign
                        </button>
                        <button 
                            type="button" 
                            className="btn btn-secondary" 
                            onClick={() => setShowModal(false)}
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};


    const LeadScraperPage = () => {
    const [loading, setLoading] = useState(false);
    const [results, setResults] = useState([]);
    const [message, setMessage] = useState('');
    const [aiAnalyzing, setAiAnalyzing] = useState(false);
    const [campaigns, setCampaigns] = useState([]);

    const [formData, setFormData] = useState({
        query: '',
        source: 'google', // Updated from previous fix
        max_results: 25,
        campaign_id: ''
    });

    useEffect(() => {
        loadCampaigns();
    }, []);

    const loadCampaigns = async () => {
        try {
            const data = await api.get('/campaigns');
            setCampaigns(data);
        } catch (error) {
            console.error('Error loading campaigns:', error);
        }
    };

    const handleScrape = async (e) => {
        e.preventDefault();
        setLoading(true);
        setMessage('');
        setResults([]);
        
        try {
            console.log('Starting scrape with data:', formData);
            
            const scrapeData = {
                query: formData.query,
                source: formData.source,
                max_results: formData.max_results,
                campaign_id: formData.campaign_id ? parseInt(formData.campaign_id) : null
            };
            
            const response = await api.post('/leads/scrape', scrapeData);
            console.log('Scrape response:', response);
            
            const campaignText = formData.campaign_id ? 
                ` and assigned to "${campaigns.find(c => c.id == formData.campaign_id)?.name}"` : '';
                
            setMessage(`ðŸš€ Scraping started! Found ${response.leads_processed || 0} leads${campaignText}. AI analysis in progress...`);
            
            // Start AI analysis
            setAiAnalyzing(true);
            
            // Simulate AI analysis progress
            setTimeout(() => {
                setAiAnalyzing(false);
                setMessage(`âœ… Complete! Successfully scraped and analyzed ${response.leads_processed || 0} leads${campaignText}.`);
                setResults(response.sample_leads || []);
            }, 3000);
            
        } catch (error) {
            console.error('Scrape error:', error);
            setMessage(`âŒ Error: ${error.response?.data?.detail || error.message}`);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fade-in">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h1 style={{fontSize: '2.5rem', fontWeight: 'bold'}}>
                    <i className="fas fa-search" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                    Lead Scraper
                </h1>
                <div style={{display: 'flex', gap: '1rem'}}>
                    <button 
                        className="btn btn-outline"
                        onClick={() => window.location.reload()}
                    >
                        <i className="fas fa-sync"></i> Reset
                    </button>
                </div>
            </div>

            <div className="card" style={{marginBottom: '2rem'}}>
                <h3 style={{marginBottom: '1rem', color: '#00d4ff'}}>
                    <i className="fas fa-robot"></i> AI-Powered Lead Discovery
                </h3>
                <p style={{opacity: 0.8, marginBottom: '2rem'}}>
                    Search for leads using Google and automatically analyze them with AI. 
                    Optionally assign found leads to a specific campaign for better organization.
                </p>

                {message && (
                    <div style={{
                        padding: '1rem',
                        marginBottom: '1rem',
                        borderRadius: '10px',
                        background: message.includes('Error') ? 'rgba(255, 107, 107, 0.2)' : 'rgba(0, 255, 136, 0.2)',
                        border: `1px solid ${message.includes('Error') ? '#ff6b6b' : '#00ff88'}`,
                        color: message.includes('Error') ? '#ff6b6b' : '#00ff88'
                    }}>
                        {message}
                    </div>
                )}

                {(loading || aiAnalyzing) && (
                    <div className="ai-processing" style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '1rem',
                        padding: '1rem',
                        marginBottom: '1rem',
                        background: 'rgba(0, 212, 255, 0.1)',
                        borderRadius: '10px',
                        border: '1px solid rgba(0, 212, 255, 0.3)'
                    }}>
                        <div className="spinner" style={{
                            width: '20px',
                            height: '20px',
                            border: '2px solid rgba(0, 212, 255, 0.3)',
                            borderTop: '2px solid #00d4ff',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <span>
                            {loading ? 'Searching Google for leads...' : 'AI is analyzing scraped leads...'}
                        </span>
                    </div>
                )}
                
                <form onSubmit={handleScrape}>
                    <div className="form-group">
                        <label className="form-label">Search Query *</label>
                        <input 
                            className="form-input"
                            type="text"
                            placeholder="e.g., SaaS companies in San Francisco, AI startups, Marketing agencies"
                            value={formData.query}
                            onChange={(e) => setFormData({...formData, query: e.target.value})}
                            required
                        />
                        <small style={{color: 'rgba(255,255,255,0.6)', fontSize: '0.8rem'}}>
                            Be specific for better results. Include industry, location, or company type.
                        </small>
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                        <div className="form-group">
                            <label className="form-label">Max Results</label>
                            <select 
                                className="form-input"
                                value={formData.max_results}
                                onChange={(e) => setFormData({...formData, max_results: parseInt(e.target.value)})}
                            >
                                <option value={10}>10 leads</option>
                                <option value={25}>25 leads</option>
                                <option value={50}>50 leads</option>
                                <option value={100}>100 leads</option>
                            </select>
                        </div>
                        
                        {/* NEW CAMPAIGN DROPDOWN */}
                        <div className="form-group">
                            <label className="form-label">Assign to Campaign</label>
                            <select 
                                className="form-input"
                                value={formData.campaign_id}
                                onChange={(e) => setFormData({...formData, campaign_id: e.target.value})}
                            >
                                <option value="">No Campaign</option>
                                {campaigns.map(campaign => (
                                    <option key={campaign.id} value={campaign.id}>
                                        {campaign.name} ({campaign.leads_count || 0} leads)
                                    </option>
                                ))}
                            </select>
                            {campaigns.length === 0 && (
                                <small style={{color: 'rgba(255,255,255,0.6)', fontSize: '0.8rem'}}>
                                    No campaigns available. Create a campaign first to organize leads.
                                </small>
                            )}
                        </div>
                    </div>
                    
                    <div className="smart-actions" style={{marginTop: '2rem'}}>
                        <button type="submit" className="btn btn-ai" disabled={loading || aiAnalyzing}>
                            {loading ? 
                                <><i className="fas fa-spinner fa-spin"></i> Searching Google...</> :
                                aiAnalyzing ?
                                <><i className="fas fa-brain"></i> AI Analyzing...</> :
                                <><i className="fas fa-search"></i> Search with Google</>
                            }
                        </button>
                        
                        {formData.campaign_id && (
                            <span style={{
                                marginLeft: '1rem',
                                padding: '0.5rem 1rem',
                                background: 'rgba(0, 212, 255, 0.2)',
                                color: '#00d4ff',
                                borderRadius: '20px',
                                fontSize: '0.9rem'
                            }}>
                                Will assign to: {campaigns.find(c => c.id == formData.campaign_id)?.name}
                            </span>
                        )}
                    </div>
                </form>
            </div>

            {/* Results Preview */}
            {results.length > 0 && (
                <div className="card">
                    <h3 style={{marginBottom: '1rem', color: '#00ff88'}}>
                        <i className="fas fa-check-circle"></i> Recent Results Preview
                    </h3>
                    <div className="table-container">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Title</th>
                                    <th>Company</th>
                                    <th>Campaign</th>
                                </tr>
                            </thead>
                            <tbody>
                                {results.map((lead, index) => (
                                    <tr key={index}>
                                        <td style={{fontWeight: 'bold'}}>
                                            {lead.first_name} {lead.last_name}
                                        </td>
                                        <td>{lead.email}</td>
                                        <td>{lead.title}</td>
                                        <td>{lead.company?.name || '-'}</td>
                                        <td>
                                            {lead.campaign ? (
                                                <span style={{
                                                    background: 'rgba(0, 212, 255, 0.2)',
                                                    color: '#00d4ff',
                                                    padding: '0.25rem 0.5rem',
                                                    borderRadius: '12px',
                                                    fontSize: '0.8rem'
                                                }}>
                                                    {lead.campaign.name}
                                                </span>
                                            ) : (
                                                <span style={{opacity: 0.5}}>No Campaign</span>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
};

   const AnalyticsPage = ({ navigateToLead }) => {
    const [analytics, setAnalytics] = useState(null);
    const [aiAnalytics, setAiAnalytics] = useState(null);
    const [trends, setTrends] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        loadAnalyticsData();
    }, []);

    const loadAnalyticsData = async () => {
        setLoading(true);
        setError(null);
        
        try {
            console.log('ðŸ” Loading analytics data...');
            
            // Try to load data with better error handling
            const [analyticsResponse, trendsResponse, aiResponse] = await Promise.allSettled([
                api.get('/analytics/dashboard').catch(err => {
                    console.warn('Analytics dashboard failed:', err);
                    return null;
                }),
                api.get('/analytics/lead-trends?days=30').catch(err => {
                    console.warn('Trends failed:', err);
                    return [];
                }),
                api.getAIDashboard().catch(err => {
                    console.warn('AI dashboard failed:', err);
                    return null;
                })
            ]);

            // Process results
            const analyticsData = analyticsResponse.status === 'fulfilled' ? analyticsResponse.value : null;
            const trendsData = trendsResponse.status === 'fulfilled' ? trendsResponse.value : [];
            const aiData = aiResponse.status === 'fulfilled' ? aiResponse.value : null;

            console.log('ðŸ“Š Analytics data loaded:', { analyticsData, trendsData, aiData });

            setAnalytics(analyticsData);
            setTrends(trendsData || []);
            setAiAnalytics(aiData);

        } catch (error) {
            console.error('âŒ Analytics loading failed:', error);
            setError(error.message);
        } finally {
            setLoading(false);
        }
    };

    // Helper function to get safe analytics data
    const getSafeAnalytics = () => {
        if (analytics?.overview) {
            return analytics;
        }
        
        // Return fallback data structure
        return {
            overview: {
                total_leads: 0,
                total_companies: 0,
                total_campaigns: 0,
                recent_leads: 0
            },
            lead_sources: [],
            lead_statuses: [],
            top_campaigns: []
        };
    };

    // Helper function to get safe AI analytics
const getSafeAIAnalytics = () => {
    // Add comprehensive debugging
    console.log('ðŸ” DEBUG: Raw aiAnalytics object:', aiAnalytics);
    console.log('ðŸ” DEBUG: Type of aiAnalytics:', typeof aiAnalytics);
    console.log('ðŸ” DEBUG: Keys in aiAnalytics:', aiAnalytics ? Object.keys(aiAnalytics) : 'null');
    
    // Check for different possible data structures
    if (aiAnalytics?.summary) {
        console.log('ðŸ” DEBUG: Found summary object:', aiAnalytics.summary);
    }
    if (aiAnalytics?.high_priority_count !== undefined) {
        console.log('ðŸ” DEBUG: Direct high_priority_count:', aiAnalytics.high_priority_count);
    }
    if (aiAnalytics?.priority_distribution) {
        console.log('ðŸ” DEBUG: Priority distribution:', aiAnalytics.priority_distribution);
    }

    // Try multiple ways to get the high priority count
    let highPriorityCount = 0;
    
    // Method 1: Direct property
    if (aiAnalytics?.high_priority_count !== undefined) {
        highPriorityCount = aiAnalytics.high_priority_count;
        console.log('ðŸ” Method 1 - Direct count:', highPriorityCount);
    }
    
    // Method 2: From summary
    if (aiAnalytics?.summary?.high_priority_count !== undefined) {
        highPriorityCount = Math.max(highPriorityCount, aiAnalytics.summary.high_priority_count);
        console.log('ðŸ” Method 2 - Summary count:', aiAnalytics.summary.high_priority_count);
    }
    
    // Method 3: From priority distribution array
    if (Array.isArray(aiAnalytics?.priority_distribution)) {
        const highPriorityItem = aiAnalytics.priority_distribution.find(item => 
            item.priority === 'high' || item.priority === 'High'
        );
        if (highPriorityItem) {
            highPriorityCount = Math.max(highPriorityCount, highPriorityItem.count);
            console.log('ðŸ” Method 3 - Distribution count:', highPriorityItem.count);
        }
    }
    
    // Method 4: Manual count from recent_insights
    if (Array.isArray(aiAnalytics?.recent_insights)) {
        const manualHighCount = aiAnalytics.recent_insights.filter(insight => 
            insight.priority === 'high' || insight.priority === 'High'
        ).length;
        console.log('ðŸ” Method 4 - Manual count from insights:', manualHighCount);
        highPriorityCount = Math.max(highPriorityCount, manualHighCount);
    }
    
    console.log('ðŸ” FINAL high priority count:', highPriorityCount);

    const result = {
        total_leads_analyzed: aiAnalytics?.total_leads_analyzed || aiAnalytics?.summary?.leads_analyzed || 0,
        high_priority_count: highPriorityCount,
        average_quality_score: aiAnalytics?.average_quality_score || aiAnalytics?.summary?.average_quality_score || 0,
        average_confidence: aiAnalytics?.average_confidence || aiAnalytics?.summary?.average_confidence || 0,
        priority_distribution: aiAnalytics?.priority_distribution || []
    };
    
    console.log('ðŸ” Final processed result:', result);
    return result;
};

    const safeAnalytics = getSafeAnalytics();
    const safeAIAnalytics = getSafeAIAnalytics();

    return (
        <div className="fade-in">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h1 style={{fontSize: '2.5rem', fontWeight: 'bold', margin: 0}}>
                    <i className="fas fa-chart-bar" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                    AI-Enhanced Analytics
                </h1>
                <button 
                    className="btn btn-ai"
                    onClick={loadAnalyticsData}
                    disabled={loading}
                >
                    <i className="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>

            {error && (
                <div className="card" style={{background: 'rgba(255, 107, 107, 0.1)', border: '1px solid rgba(255, 107, 107, 0.3)', marginBottom: '2rem'}}>
                    <div style={{color: '#ff6b6b'}}>
                        <i className="fas fa-exclamation-triangle" style={{marginRight: '0.5rem'}}></i>
                        Error loading analytics: {error}
                    </div>
                    <button 
                        className="btn btn-secondary" 
                        onClick={loadAnalyticsData}
                        style={{marginTop: '1rem'}}
                    >
                        Try Again
                    </button>
                </div>
            )}

            {/* Overview Cards */}
            <div className="stats-grid" style={{marginBottom: '2rem'}}>
                <div className="stat-card">
                    <div className="stat-value">{safeAnalytics.overview.total_leads.toLocaleString()}</div>
                    <div className="stat-label">Total Leads</div>
                    <div className="stat-change positive">
                        <i className="fas fa-arrow-up"></i>
                        {safeAnalytics.overview.recent_leads} this week
                    </div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-value">{safeAnalytics.overview.total_companies.toLocaleString()}</div>
                    <div className="stat-label">Companies</div>
                </div>
                
                <div className="stat-card">
                    <div className="stat-value">{safeAnalytics.overview.total_campaigns.toLocaleString()}</div>
                    <div className="stat-label">Campaigns</div>
                </div>
                
                <div className="stat-card ai-card">
                    <div className="stat-value ai-value">{safeAIAnalytics.total_leads_analyzed.toLocaleString()}</div>
                    <div className="stat-label">AI Analyzed</div>
                </div>
            </div>

            {/* AI Performance Section */}
            {safeAIAnalytics.total_leads_analyzed > 0 ? (
                <div className="card ai-enhanced" style={{marginBottom: '2rem'}}>
                    <h2 style={{marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                        <i className="fas fa-brain" style={{color: '#00ff88'}}></i>
                        AI Performance Metrics
                    </h2>
                    
                    <div className="stats-grid">
                        <div className="stat-card ai-card">
                            <div className="stat-value ai-value">{safeAIAnalytics.high_priority_count}</div>
                            <div className="stat-label">High Priority Leads</div>
                            <div className="stat-change positive">
                                <i className="fas fa-star"></i>
                                {safeAIAnalytics.total_leads_analyzed > 0 ? 
                                    ((safeAIAnalytics.high_priority_count / safeAIAnalytics.total_leads_analyzed) * 100).toFixed(1) : 0}% of total
                            </div>
                        </div>
                        
                        <div className="stat-card ai-card">
                            <div className="stat-value ai-value">{Math.round(safeAIAnalytics.average_quality_score)}%</div>
                            <div className="stat-label">Avg Data Quality</div>
                        </div>
                        
                        <div className="stat-card ai-card">
                            <div className="stat-value ai-value">{Math.round(safeAIAnalytics.average_confidence * 100)}%</div>
                            <div className="stat-label">AI Confidence</div>
                        </div>
                        
                        <div className="stat-card ai-card">
                            <div className="stat-value ai-value">
                                {safeAIAnalytics.priority_distribution.length}
                            </div>
                            <div className="stat-label">Priority Levels</div>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="card" style={{marginBottom: '2rem', textAlign: 'center', padding: '3rem'}}>
                    <i className="fas fa-robot" style={{fontSize: '4rem', color: '#00d4ff', marginBottom: '1rem', opacity: 0.7}}></i>
                    <h3 style={{color: '#00d4ff', marginBottom: '1rem'}}>AI Analysis Not Yet Available</h3>
                    <p style={{opacity: 0.8, marginBottom: '2rem'}}>
                        Add some leads and run AI analysis to see intelligent insights and performance metrics.
                    </p>
                    <button 
                        className="btn btn-ai"
                        onClick={() => navigateToLead ? navigateToLead(null) : console.log('Navigate to leads')}
                    >
                        <i className="fas fa-plus"></i>
                        Add Leads
                    </button>
                </div>
            )}

            {/* Lead Sources and Trends */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginBottom: '2rem'}}>
                
                {/* Lead Sources */}
                <div className="card">
                    <h2 style={{marginBottom: '1.5rem'}}>Lead Sources Distribution</h2>
                    {safeAnalytics.lead_sources && safeAnalytics.lead_sources.length > 0 ? (
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1.5rem'}}>
                            {safeAnalytics.lead_sources.map((source, index) => (
                                <div key={source.source || index} style={{textAlign: 'center'}}>
                                    <div style={{
                                        width: '80px',
                                        height: '80px',
                                        margin: '0 auto 1rem',
                                        borderRadius: '50%',
                                        background: `conic-gradient(#00d4ff 0deg, #7c3aed ${(source.count / safeAnalytics.overview.total_leads) * 360}deg, rgba(255,255,255,0.1) ${(source.count / safeAnalytics.overview.total_leads) * 360}deg)`,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold'
                                    }}>
                                        {source.count}
                                    </div>
                                    <div style={{textTransform: 'capitalize', fontWeight: 'bold'}}>
                                        {source.source || 'Unknown'}
                                    </div>
                                    <div style={{opacity: 0.7, fontSize: '0.9rem'}}>
                                        {safeAnalytics.overview.total_leads > 0 ? 
                                            ((source.count / safeAnalytics.overview.total_leads) * 100).toFixed(1) : 0}%
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div style={{textAlign: 'center', padding: '2rem', opacity: 0.7}}>
                            <i className="fas fa-chart-pie" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                            <p>No lead source data available yet.</p>
                        </div>
                    )}
                </div>

                {/* Lead Status Breakdown */}
                <div className="card">
                    <h2 style={{marginBottom: '1.5rem'}}>Lead Status Breakdown</h2>
                    {safeAnalytics.lead_statuses && safeAnalytics.lead_statuses.length > 0 ? (
                        <div style={{display: 'grid', gap: '1rem'}}>
                            {safeAnalytics.lead_statuses.map((status, index) => (
                                <div key={status.status || index} style={{
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    padding: '1rem',
                                    background: 'rgba(255, 255, 255, 0.05)',
                                    borderRadius: '8px',
                                    border: '1px solid rgba(255, 255, 255, 0.1)'
                                }}>
                                    <span style={{textTransform: 'capitalize', fontWeight: 'bold'}}>
                                        {status.status || 'Unknown'}
                                    </span>
                                    <div style={{textAlign: 'right'}}>
                                        <div style={{color: '#00d4ff', fontWeight: 'bold', fontSize: '1.2rem'}}>
                                            {status.count}
                                        </div>
                                        <div style={{opacity: 0.7, fontSize: '0.8rem'}}>
                                            {safeAnalytics.overview.total_leads > 0 ? 
                                                ((status.count / safeAnalytics.overview.total_leads) * 100).toFixed(1) : 0}%
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div style={{textAlign: 'center', padding: '2rem', opacity: 0.7}}>
                            <i className="fas fa-tasks" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                            <p>No status data available yet.</p>
                        </div>
                    )}
                </div>
            </div>

            {/* Lead Trends Chart */}
            <div className="card">
                <h2 style={{marginBottom: '1.5rem'}}>Lead Trends (Last 30 Days)</h2>
                {trends && trends.length > 0 ? (
                    <div style={{padding: '1rem'}}>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: `repeat(${Math.min(trends.length, 15)}, 1fr)`,
                            gap: '0.5rem',
                            height: '200px',
                            alignItems: 'end',
                            marginBottom: '1rem'
                        }}>
                            {trends.slice(-15).map((trend, index) => {
                                const maxCount = Math.max(...trends.map(t => t.count));
                                const height = maxCount > 0 ? (trend.count / maxCount) * 180 : 10;
                                
                                return (
                                    <div key={index} style={{textAlign: 'center'}}>
                                        <div 
                                            style={{
                                                background: 'linear-gradient(45deg, #00d4ff, #7c3aed)',
                                                height: `${height}px`,
                                                borderRadius: '4px 4px 0 0',
                                                marginBottom: '0.5rem',
                                                position: 'relative',
                                                cursor: 'pointer'
                                            }}
                                            title={`${trend.date}: ${trend.count} leads`}
                                        >
                                            <div style={{
                                                position: 'absolute',
                                                top: '-25px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                fontSize: '0.7rem',
                                                fontWeight: 'bold',
                                                color: '#00d4ff'
                                            }}>
                                                {trend.count}
                                            </div>
                                        </div>
                                        <div style={{fontSize: '0.6rem', opacity: 0.7}}>
                                            {new Date(trend.date).getDate()}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', opacity: 0.7}}>
                            <span>ðŸ“ˆ Total: {trends.reduce((sum, t) => sum + t.count, 0)} leads</span>
                            <span>ðŸ“Š Average: {(trends.reduce((sum, t) => sum + t.count, 0) / trends.length).toFixed(1)} per day</span>
                        </div>
                    </div>
                ) : (
                    <div style={{textAlign: 'center', padding: '3rem', opacity: 0.7}}>
                        <i className="fas fa-chart-line" style={{fontSize: '3rem', marginBottom: '1rem', color: '#00d4ff'}}></i>
                        <p>No trend data available yet.</p>
                        <p style={{fontSize: '0.9rem'}}>Add some leads to see growth patterns.</p>
                    </div>
                )}
            </div>

            {/* Top Campaigns */}
            {safeAnalytics.top_campaigns && safeAnalytics.top_campaigns.length > 0 && (
                <div className="card" style={{marginTop: '2rem'}}>
                    <h2 style={{marginBottom: '1.5rem'}}>
                        <i className="fas fa-trophy" style={{marginRight: '0.5rem', color: '#00d4ff'}}></i>
                        Top Performing Campaigns
                    </h2>
                    <div style={{display: 'grid', gap: '1rem'}}>
                        {safeAnalytics.top_campaigns.map((campaign, index) => (
                            <div key={index} style={{
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center', 
                                padding: '1rem', 
                                background: 'rgba(255, 255, 255, 0.05)',
                                borderRadius: '8px',
                                border: '1px solid rgba(255, 255, 255, 0.1)'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                                    <div style={{
                                        background: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#00d4ff',
                                        color: '#000',
                                        width: '30px',
                                        height: '30px',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontWeight: 'bold',
                                        fontSize: '0.9rem'
                                    }}>
                                        {index + 1}
                                    </div>
                                    <span style={{fontWeight: 'bold'}}>{campaign.name}</span>
                                </div>
                                <span style={{color: '#00d4ff', fontWeight: 'bold'}}>
                                    {campaign.leads_count} leads
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Call to Action */}
            {safeAnalytics.overview.total_leads === 0 && (
                <div className="card" style={{marginTop: '2rem', textAlign: 'center', padding: '3rem'}}>
                    <i className="fas fa-rocket" style={{fontSize: '4rem', color: '#00d4ff', marginBottom: '1rem', opacity: 0.7}}></i>
                    <h3 style={{color: '#00d4ff', marginBottom: '1rem'}}>Ready to Get Started?</h3>
                    <p style={{opacity: 0.8, marginBottom: '2rem'}}>
                        Start by adding some leads to see powerful analytics and AI insights in action.
                    </p>
                    <div style={{display: 'flex', gap: '1rem', justifyContent: 'center'}}>
                        <button 
                            className="btn btn-ai"
                            onClick={() => navigateToLead ? navigateToLead(null) : console.log('Navigate to leads')}
                        >
                            <i className="fas fa-plus"></i>
                            Add Leads Manually
                        </button>
                        <button 
                            className="btn btn-secondary"
                            onClick={() => console.log('Navigate to scraper')}
                        >
                            <i className="fas fa-search"></i>
                            Scrape Leads
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

    // FIXED VERSION: AI Insights Page
const AIInsightsPage = ({ navigateToLead, handleAIAction, setActiveTab }) => {
    const [insights, setInsights] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeFilter, setActiveFilter] = useState('all');
    const [dashboardData, setDashboardData] = useState(null);
    const [totalCount, setTotalCount] = useState(0);

    useEffect(() => {
        loadInsights();
    }, []);

    const loadInsights = async () => {
        setLoading(true);
        try {
            const [dashboardResponse, insightsResponse] = await Promise.all([
                api.get('/ai/dashboard?time_range_days=90').catch(() => null),
                api.get('/ai/insights?limit=100').catch(() => null)
            ]);
            
            let allInsights = [];
            
            if (dashboardResponse?.recent_insights) {
                allInsights = [...allInsights, ...dashboardResponse.recent_insights];
            }
            
            if (insightsResponse?.insights) {
                allInsights = [...allInsights, ...insightsResponse.insights];
            }
            
            const uniqueInsights = allInsights.filter((insight, index, self) => 
                index === self.findIndex(i => i.id === insight.id)
            );
            
            setInsights(uniqueInsights);
            setTotalCount(uniqueInsights.length);
            setDashboardData(dashboardResponse);
            
        } catch (error) {
            console.error('Error loading insights:', error);
        } finally {
            setLoading(false);
        }
    };

    const filterInsights = (insights, filter) => {
        if (filter === 'all') return insights;
        return insights.filter(insight => insight.priority === filter);
    };

    const filteredInsights = filterInsights(insights, activeFilter);

    if (loading) return <LoadingSpinner />;

    return (
        <div className="fade-in">
            <h1 style={{marginBottom: '2rem', fontSize: '2.5rem', fontWeight: 'bold'}}>
                <i className="fas fa-brain" style={{marginRight: '1rem', color: '#00d4ff'}}></i>
                AI Insights Dashboard
                <span style={{
                    fontSize: '1rem', 
                    opacity: 0.7, 
                    marginLeft: '1rem',
                    fontWeight: 'normal'
                }}>
                    ({totalCount} total insights)
                </span>
            </h1>

            {/* Filter Buttons */}
            <div style={{marginBottom: '2rem'}}>
                <div className="smart-actions">
                    {['all', 'critical', 'high', 'medium', 'low'].map(filter => (
                        <button
                            key={filter}
                            className={`btn ${activeFilter === filter ? 'btn-ai' : 'btn-secondary'}`}
                            onClick={() => setActiveFilter(filter)}
                        >
                            {filter.charAt(0).toUpperCase() + filter.slice(1)}
                            <span style={{marginLeft: '0.5rem', opacity: 0.7}}>
                                ({filter === 'all' ? totalCount : insights.filter(i => i.priority === filter).length})
                            </span>
                        </button>
                    ))}
                    <button className="btn btn-success" onClick={loadInsights}>
                        <i className="fas fa-sync"></i>
                        Refresh All
                    </button>
                    <button 
                        className="btn btn-outline"
                        onClick={() => setActiveTab('scraper')}
                    >
                        <i className="fas fa-plus"></i>
                        Add More Leads
                    </button>
                </div>
            </div>

            {/* Insights Grid */}
            {filteredInsights.length > 0 ? (
                <div style={{display: 'grid', gap: '1.5rem'}}>
                    {filteredInsights.map(insight => (
                        <div key={insight.id} className="insight-card" style={{
                            background: 'rgba(30, 30, 40, 0.95)',
                            border: '1px solid rgba(0, 212, 255, 0.3)',
                            borderRadius: '12px',
                            padding: '1.5rem',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem'}}>
                                <div>
                                    <h3 style={{margin: 0, color: '#00d4ff', fontSize: '1.2rem'}}>
                                        {insight.lead_name || `Lead #${insight.lead_id}`}
                                    </h3>
                                    <p style={{margin: 0, opacity: 0.7, fontSize: '0.9rem'}}>
                                        {insight.type} â€¢ {new Date(insight.created_at).toLocaleDateString()}
                                    </p>
                                </div>
                                <div style={{
                                    padding: '0.25rem 0.75rem',
                                    borderRadius: '20px',
                                    fontSize: '0.8rem',
                                    fontWeight: 'bold',
                                    background: insight.priority === 'critical' ? '#ff4444' :
                                               insight.priority === 'high' ? '#ff8800' :
                                               insight.priority === 'medium' ? '#ffaa00' : '#888',
                                    color: 'white'
                                }}>
                                    {insight.priority.toUpperCase()}
                                </div>
                            </div>
                            
                            <p style={{
                                margin: '1rem 0',
                                lineHeight: '1.6',
                                color: '#ffffff'
                            }}>
                                {insight.text}
                            </p>
                            
                            <div style={{
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'space-between',
                                marginTop: '1rem',
                                paddingTop: '1rem',
                                borderTop: '1px solid rgba(255,255,255,0.1)'
                            }}>
                                {insight.confidence && (
                                    <span style={{fontSize: '0.9rem', opacity: 0.8}}>
                                        Confidence: {Math.round(insight.confidence * 100)}%
                                    </span>
                                )}
                                
                                <div className="smart-actions">
                                    <button 
                                        className="btn btn-sm btn-outline"
                                        onClick={() => navigateToLead(insight.lead_id)}
                                        title="Go to leads page and highlight this lead"
                                    >
                                        <i className="fas fa-eye"></i>
                                        View Lead
                                    </button>
                                    
                                    <div className="dropdown" style={{position: 'relative', display: 'inline-block'}}>
                                        <button 
                                            className="btn btn-sm btn-ai"
                                            onClick={() => {
                                                const dropdown = document.getElementById(`dropdown-${insight.id}`);
                                                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                                            }}
                                        >
                                            <i className="fas fa-robot"></i>
                                            AI Actions
                                            <i className="fas fa-chevron-down" style={{marginLeft: '0.5rem'}}></i>
                                        </button>
                                        
                                        <div 
                                            id={`dropdown-${insight.id}`}
                                            style={{
                                                display: 'none',
                                                position: 'absolute',
                                                right: 0,
                                                top: '100%',
                                                background: 'rgba(20, 20, 30, 0.95)',
                                                border: '1px solid rgba(0, 212, 255, 0.3)',
                                                borderRadius: '8px',
                                                padding: '0.5rem',
                                                minWidth: '200px',
                                                zIndex: 1000,
                                                marginTop: '0.5rem'
                                            }}
                                        >
                                            <button 
                                                className="btn btn-sm btn-outline"
                                                style={{width: '100%', marginBottom: '0.5rem'}}
                                                onClick={() => {
                                                    handleAIAction(insight.lead_id, 'analyze');
                                                    document.getElementById(`dropdown-${insight.id}`).style.display = 'none';
                                                }}
                                            >
                                                <i className="fas fa-search"></i>
                                                Re-analyze Lead
                                            </button>
                                            
                                            <button 
                                                className="btn btn-sm btn-outline"
                                                style={{width: '100%', marginBottom: '0.5rem'}}
                                                onClick={() => {
                                                    handleAIAction(insight.lead_id, 'similar');
                                                    document.getElementById(`dropdown-${insight.id}`).style.display = 'none';
                                                }}
                                            >
                                                <i className="fas fa-users"></i>
                                                Find Similar
                                            </button>
                                            
                                            <button 
                                                className="btn btn-sm btn-outline"
                                                style={{width: '100%'}}
                                                onClick={() => {
                                                    handleAIAction(insight.lead_id, 'quality');
                                                    document.getElementById(`dropdown-${insight.id}`).style.display = 'none';
                                                }}
                                            >
                                                <i className="fas fa-check-circle"></i>
                                                Check Quality
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div style={{
                    textAlign: 'center', 
                    padding: '4rem 2rem',
                    background: 'rgba(30, 30, 40, 0.5)',
                    borderRadius: '12px',
                    border: '2px dashed rgba(0, 212, 255, 0.3)'
                }}>
                    <i className="fas fa-lightbulb" style={{
                        fontSize: '4rem', 
                        marginBottom: '1rem', 
                        color: '#00d4ff',
                        opacity: 0.7
                    }}></i>
                    <h3 style={{marginBottom: '1rem', color: '#00d4ff'}}>
                        No AI insights available
                    </h3>
                    <p style={{opacity: 0.7, marginBottom: '2rem'}}>
                        {totalCount === 0 
                            ? "Add some leads and let our AI analyze them to generate intelligent insights."
                            : `No insights match the "${activeFilter}" priority filter.`
                        }
                    </p>
                    <div className="smart-actions">
                        <button 
                            className="btn btn-ai"
                            onClick={() => setActiveTab('scraper')}
                        >
                            <i className="fas fa-plus"></i>
                            Add Leads
                        </button>
                        <button 
                            className="btn btn-outline"
                            onClick={loadInsights}
                        >
                            <i className="fas fa-sync"></i>
                            Reload All
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

    const AuthForm = ({ isLogin, onSubmit, loading }) => {
        const [formData, setFormData] = useState({
            email: '',
            username: '',
            password: ''
        });

        const handleSubmit = (e) => {
            e.preventDefault();
            onSubmit(formData);
        };

        return (
            <div className="auth-container">
                <div className="auth-card">
                    <div className="auth-title">
                        <i className="fas fa-rocket" style={{marginRight: '0.5rem'}}></i>
                        LeadGen Pro
                    </div>
                    <h2 style={{marginBottom: '2rem', opacity: 0.9}}>
                        {isLogin ? 'Welcome Back' : 'Create Account'}
                    </h2>
                    <form onSubmit={handleSubmit}>
                        {!isLogin && (
                            <div className="form-group">
                                <input 
                                    className="form-input"
                                    type="email"
                                    placeholder="Email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                            </div>
                        )}
                        <div className="form-group">
                            <input 
                                className="form-input"
                                type="text"
                                placeholder="Username"
                                value={formData.username}
                                onChange={(e) => setFormData({...formData, username: e.target.value})}
                                required
                            />
                        </div>
                        <div className="form-group">
                            <input 
                                className="form-input"
                                type="password"
                                placeholder="Password"
                                value={formData.password}
                                onChange={(e) => setFormData({...formData, password: e.target.value})}
                                required
                            />
                        </div>
                        <button type="submit" className="btn" style={{width: '100%'}} disabled={loading}>
                            {loading ? (
                                <>
                                    <div className="spinner" style={{width: '16px', height: '16px', marginRight: '0.5rem'}}></div>
                                    Processing...
                                </>
                            ) : (
                                isLogin ? 'Sign In' : 'Create Account'
                            )}
                        </button>
                    </form>
                </div>
            </div>
        );
    };

const App = () => {
    const { user, login, register, loading } = useAuth();
    const [activeTab, setActiveTab] = useState('dashboard');
    const [isLogin, setIsLogin] = useState(true);
    const [authLoading, setAuthLoading] = useState(false);
    const [selectedLeadId, setSelectedLeadId] = useState(null); // Added for lead navigation

    const handleAuth = async (formData) => {
        setAuthLoading(true);
        try {
            if (isLogin) {
                await login(formData.username, formData.password);
            } else {
                await register(formData.email, formData.username, formData.password);
            }
        } catch (error) {
            alert(error.message);
        } finally {
            setAuthLoading(false);
        }
    };

    // Navigation helper function for navigating to specific leads
    const navigateToLead = (leadId) => {
        setSelectedLeadId(leadId);
        setActiveTab('leads');
    };

    // Function to handle AI actions
    const handleAIAction = async (leadId, actionType) => {
        try {
            let response;
            switch (actionType) {
                case 'analyze':
                    response = await api.get(`/leads/${leadId}/ai-insights?force_refresh=true`);
                    console.log('AI Analysis result:', response);
                    break;
                case 'similar':
                    response = await api.post('/ai/find-similar', { reference_lead_id: leadId });
                    console.log('Similar leads found:', response);
                    break;
                case 'quality':
                    response = await api.get(`/leads/${leadId}/data-quality`);
                    console.log('Quality assessment:', response);
                    break;
                case 'refresh':
                    // Refresh insights
                    window.location.reload();
                    return;
                default:
                    console.log(`AI action: ${actionType} for lead ${leadId}`);
                    return;
            }
            
            // Show success message
            alert(`AI action "${actionType}" completed successfully! Check the console for details.`);
            
            // Optionally refresh the current page data
            if (activeTab === 'ai-insights') {
                // Trigger a refresh of the AI insights page
                window.dispatchEvent(new CustomEvent('refreshInsights'));
            }
            
        } catch (error) {
            console.error('AI action failed:', error);
            alert(`AI action "${actionType}" failed: ${error.message || 'Unknown error'}`);
        }
    };

    // Function to handle navigation between tabs
    const handleTabChange = (tabId) => {
        // Clear selected lead when changing tabs (except when going to leads)
        if (tabId !== 'leads') {
            setSelectedLeadId(null);
        }
        setActiveTab(tabId);
    };

    if (loading) {
        return (
            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh'}}>
                <LoadingSpinner />
            </div>
        );
    }

    if (!user) {
        return (
            <div>
                <AuthForm 
                    isLogin={isLogin} 
                    onSubmit={handleAuth} 
                    loading={authLoading}
                />
                <div style={{textAlign: 'center', marginTop: '1rem'}}>
                    <button 
                        onClick={() => setIsLogin(!isLogin)}
                        style={{background: 'none', border: 'none', color: '#00d4ff', cursor: 'pointer'}}
                    >
                        {isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in"}
                    </button>
                </div>
            </div>
        );
    }

    const renderContent = () => {
    switch (activeTab) {
        case 'dashboard': 
            return <Dashboard 
                navigateToLead={navigateToLead} 
                handleAIAction={handleAIAction}
                setActiveTab={setActiveTab}  // ADD THIS LINE
            />;
        case 'leads': 
            return <LeadsPage 
                selectedLeadId={selectedLeadId} 
                setSelectedLeadId={setSelectedLeadId}
                handleAIAction={handleAIAction}
            />;
        case 'companies': 
            return <CompaniesPage />;
        case 'campaigns': 
            return <CampaignsPage />;
        case 'scraper': 
            return <LeadScraperPage 
                setActiveTab={setActiveTab}
            />;
        case 'analytics': 
            return <AnalyticsPage 
                navigateToLead={navigateToLead}
            />;
        case 'ai-insights': 
            return <AIInsightsPage 
                navigateToLead={navigateToLead} 
                handleAIAction={handleAIAction}
                setActiveTab={setActiveTab}
            />;
        default: 
            return <Dashboard 
                navigateToLead={navigateToLead} 
                handleAIAction={handleAIAction}
                setActiveTab={setActiveTab}  // ADD THIS LINE
            />;
    }
};

    return (
        <div className="app">
            <Sidebar 
                activeTab={activeTab} 
                setActiveTab={handleTabChange}
            />
            <div className="main-content">
                <Header user={user} />
                {renderContent()}
            </div>
        </div>
    );
};

    const Root = () => (
        <AuthProvider>
            <App />
        </AuthProvider>
    );

    ReactDOM.render(<Root />, document.getElementById('root'));
    </script>
</body>
</html>